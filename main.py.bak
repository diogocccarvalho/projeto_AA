import pickle
import os
from simulador import Simulador
from gui import GuiRecolecao, GuiFarol
from ambientes.ambiente_farol import AmbienteFarol
from ambientes.ambiente_recolecao import AmbienteRecolecao

from agentes.agenteFarolQ import AgenteFarolQ
from agentes.agenteRecolecaoQ import AgenteRecolecaoQ
from agentes.agenteFarolEvo import AgenteFarolEvo
from agentes.agenteRecolecaoEvo import AgenteRecolecaoEvo

def main():
    sim = Simulador()

    CENARIO = "FAROL"
    MODO = "TREINO_EVO" # "TREINO_Q", "TREINO_EVO", "DEMO_Q", "DEMO_EVO", "DEMO_TEAMS"

    if CENARIO == "FAROL":
        amb = AmbienteFarol(largura=50, altura=50, num_obstaculos=100)
        gui = GuiFarol(amb, simulador=sim)
        ClasseQ = AgenteFarolQ
        ClasseAgenteEvo = AgenteFarolEvo
        save_file_q = "agente_farol_q.pkl"
        save_file_evo = "agente_farol_evo.pkl"
    else: # RECOLECAO
        amb = AmbienteRecolecao(largura=25, altura=25, num_obstaculos=25)
        gui = GuiRecolecao(amb, simulador=sim)
        ClasseQ = AgenteRecolecaoQ
        ClasseAgenteEvo = AgenteRecolecaoEvo
        save_file_q = "agente_recolecao_q.pkl"
        save_file_evo = "agente_recolecao_evo.pkl"

    sim.cria(amb)


    if MODO == "TREINO_Q":
        num_agentes = 2
        for _ in range(num_agentes):
            agente = ClasseQ()
            agente.learning_mode = True
            sim.adicionar_agente(agente, verbose=False)
        print(f"{num_agentes} agentes adicionados para treino Q-learning.")
        sim.treinar_q(num_episodios=5000, guardar_em=save_file_q)

    elif MODO == "TREINO_EVO":
        if ClasseAgenteEvo:
            sim.treinar_genetico(ClasseAgenteEvo, num_geracoes=1000, pop_size=10, guardar_em=save_file_evo)
        else:
            print("Classe de Agente Evolucionário não definida para este cenário.")

    elif MODO == "DEMO_Q":
        print("--- MODO DEMONSTRAÇÃO Q-LEARNING ---")
        cerebro_q = None
        if os.path.exists(save_file_q):
            with open(save_file_q, "rb") as f:
                cerebro_q = pickle.load(f)
        
        num_agentes = 2
        for _ in range(num_agentes):
            agente = ClasseQ()
            if cerebro_q and hasattr(cerebro_q, 'q_table'):
                agente.q_table = cerebro_q.q_table
            agente.learning_mode = False
            sim.adicionar_agente(agente, verbose=False)
        print(f"{num_agentes} agentes Q-learning adicionados para demonstração.")
        
        sim.executa_episodio(visualizador=gui, delay=0.1)
        gui.root.mainloop()

    elif MODO == "DEMO_EVO":
        print("--- MODO DEMONSTRAÇÃO EVOLUCIONÁRIO ---")
        cerebro_evo = None
        if os.path.exists(save_file_evo):
            with open(save_file_evo, "rb") as f:
                cerebro_evo = pickle.load(f)
        
        num_agentes = 2
        for _ in range(num_agentes):
            agente = ClasseAgenteEvo()
            if cerebro_evo:
                agente.genes = cerebro_evo.genes
            agente.learning_mode = False
            sim.adicionar_agente(agente, verbose=False)
        print(f"{num_agentes} agentes evolucionários adicionados para demonstração.")
        
        sim.executa_episodio(visualizador=gui, delay=0.1)
        gui.root.mainloop()

    elif MODO == "DEMO_TEAMS":
        print("--- MODO TORNEIO ---")
        cerebro_q = None
        if os.path.exists(save_file_q):
            with open(save_file_q, "rb") as f:
                cerebro_q = pickle.load(f)

        cerebro_evo = None
        if os.path.exists(save_file_evo):
            with open(save_file_evo, "rb") as f:
                cerebro_evo = pickle.load(f)

        # Equipa Q-Learning
        num_agentes_q = 2
        for _ in range(num_agentes_q):
            agente_q = ClasseQ()
            if cerebro_q and hasattr(cerebro_q, 'q_table'):
                agente_q.q_table = cerebro_q.q_table.copy()
            agente_q.learning_mode = False
            sim.adicionar_agente(agente_q, equipa_id=1, verbose=False)
        print(f"{num_agentes_q} agentes Q-learning adicionados à equipa 1.")

        # Equipa Evolucionária
        num_agentes_evo = 2
        for _ in range(num_agentes_evo):
            agente_evo = ClasseAgenteEvo()
            if cerebro_evo:
                agente_evo.genes = cerebro_evo.genes
            agente_evo.learning_mode = False
            sim.adicionar_agente(agente_evo, equipa_id=2, verbose=False)
        print(f"{num_agentes_evo} agentes evolucionários adicionados à equipa 2.")
        
        pontos = {1: 0, 2: 0}
        for r in range(1, 6):
            print(f"Ronda {r}...")
            sim.executa_episodio(visualizador=gui, delay=0.05)
            scores = sim.obter_scores_equipas()
            for eq in [1, 2]:
                pontos[eq] += scores.get(eq, 0)
            print(f"Resultado da Ronda: {scores}")
        
        print(f"PONTUAÇÃO FINAL: {pontos}")
        gui.root.mainloop()

if __name__ == "__main__":
    main()
